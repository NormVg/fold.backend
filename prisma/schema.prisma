// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(uuid()) @db.Uuid
  email         String    @unique @db.VarChar(255)

  // Authentication
  passwordHash  String?   @map("password_hash") @db.Text
  authProvider  String?   @map("auth_provider") @db.VarChar(50)
  lastLoginAt   DateTime? @map("last_login_at")

  // Profile
  name          String?   @db.VarChar(255)
  avatarUrl     String?   @map("avatar_url") @db.Text

  // Preferences
  theme         String?   @default("light") @db.VarChar(20)

  // Account state
  status        String    @default("active") @db.VarChar(20)

  // Security & audit
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Refresh tokens for session management
  refreshTokens RefreshToken[]

  // Content
  memories      Memory[]
  stories       Story[]
  badges        Badge[]

  @@map("users")
}

model RefreshToken {
  id          String   @id @default(uuid()) @db.Uuid
  token       String   @unique @db.Text
  userId      String   @map("user_id") @db.Uuid
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")
  revokedAt   DateTime? @map("revoked_at")
  userAgent   String?  @map("user_agent") @db.Text
  ipAddress   String?  @map("ip_address") @db.VarChar(45)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ============ Memory ============

model Memory {
  id              String    @id @default(uuid()) @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  mood            Int       @db.SmallInt // -2 (v.sad) to 2 (v.happy)

  // Text
  textContent     String?   @map("text_content") @db.Text

  // Audio
  audioUrl        String?   @map("audio_url") @db.Text
  audioDurationSec Int?     @map("audio_duration_sec")

  // Image
  imageUrl        String?   @map("image_url") @db.Text
  imageWidth      Int?      @map("image_width")
  imageHeight     Int?      @map("image_height")

  // Video
  videoUrl        String?   @map("video_url") @db.Text
  videoDurationSec Int?     @map("video_duration_sec")

  // Location
  latitude        Decimal?  @db.Decimal(9, 6)
  longitude       Decimal?  @db.Decimal(9, 6)
  locationName    String?   @map("location_name") @db.Text

  // System
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  visibility      String    @default("private") @db.VarChar(20) // private, friends, public

  @@index([userId, createdAt(sort: Desc)])
  @@map("memory")
}

// ============ Story ============

model Story {
  id          String      @id @default(uuid()) @db.Uuid
  userId      String      @map("user_id") @db.Uuid
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  title       String?     @db.Text

  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  visibility  String      @default("private") @db.VarChar(20) // private, friends, public

  pages       StoryPage[]

  @@index([userId, createdAt(sort: Desc)])
  @@map("story")
}

model StoryPage {
  id               String   @id @default(uuid()) @db.Uuid
  storyId          String   @map("story_id") @db.Uuid
  story            Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  pageText         String?  @map("page_text") @db.Text
  pageNumber       Int      @map("page_number")

  isAttachedVideos Boolean  @default(false) @map("is_attached_videos")
  isAttachedImages Boolean  @default(false) @map("is_attached_images")
  isAttachedAudios Boolean  @default(false) @map("is_attached_audios")

  videos           StoryPageVideo[]
  audios           StoryPageAudio[]
  images           StoryPageImage[]

  @@unique([storyId, pageNumber])
  @@index([storyId, pageNumber])
  @@map("story_pages")
}

model StoryPageVideo {
  id              String    @id @default(uuid()) @db.Uuid
  storyPageId     String    @map("story_page_id") @db.Uuid
  storyPage       StoryPage @relation(fields: [storyPageId], references: [id], onDelete: Cascade)

  videoUrl        String    @map("video_url") @db.Text
  videoDurationSec Int?     @map("video_duration_sec")

  @@map("story_page_videos")
}

model StoryPageAudio {
  id              String    @id @default(uuid()) @db.Uuid
  storyPageId     String    @map("story_page_id") @db.Uuid
  storyPage       StoryPage @relation(fields: [storyPageId], references: [id], onDelete: Cascade)

  audioUrl        String    @map("audio_url") @db.Text
  audioDurationSec Int?     @map("audio_duration_sec")

  @@map("story_page_audios")
}

model StoryPageImage {
  id          String    @id @default(uuid()) @db.Uuid
  storyPageId String    @map("story_page_id") @db.Uuid
  storyPage   StoryPage @relation(fields: [storyPageId], references: [id], onDelete: Cascade)

  imageUrl    String    @map("image_url") @db.Text
  imageSize   Int?      @map("image_size")

  @@map("story_page_images")
}

// ============ Badges ============

model Badge {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String   @db.VarChar(255)
  slug        String   @unique @db.VarChar(255)
  description String?  @db.Text

  iconUrl     String?  @map("icon_url") @db.Text

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("badges")
}
